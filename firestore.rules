rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========== HELPERS DE BASE ==========
    function isSignedIn() {
      return request.auth != null;
    }

    function hasUserDoc() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserData() {
      return hasUserDoc() 
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        : null;
    }

    function userRole() {
      return hasUserDoc() ? getUserData().role : null;
    }

    function userGroupId() {
      return hasUserDoc() ? getUserData().groupId : null;
    }

    // ========== VÉRIFICATIONS DE RÔLES ==========
    // Rôles hiérarchiques:
    // - 'user' (utilisateur standard - priorité 10)
    // - 'tracker' (utilisateur traceur - priorité 20)
    // - 'group' (administrateur de groupe - priorité 50)
    // - 'admin' (administrateur master - priorité 90)
    // - 'superAdmin' (super administrateur - priorité 100)

    function isSuperAdmin() {
      return hasUserDoc() && userRole() == 'superAdmin';
    }

    function isMasterAdmin() {
      return hasUserDoc() && (
        getUserData().isAdmin == true 
        || userRole() == 'admin'
        || userRole() == 'superAdmin'
      );
    }

    function isGroupAdmin(groupId) {
      return hasUserDoc() 
        && userRole() == 'group' 
        && userGroupId() == groupId;
    }

    function isTracker() {
      return hasUserDoc() && (
        userRole() == 'tracker' 
        || userRole() == 'group'
        || isMasterAdmin()
      );
    }

    function isAtLeastGroupAdmin() {
      return hasUserDoc() && (
        userRole() == 'group'
        || userRole() == 'admin'
        || userRole() == 'superAdmin'
      );
    }

    // ========== VÉRIFICATIONS DE PERMISSIONS ==========
    function canManageUsers() {
      return isMasterAdmin();
    }

    function canManageContent() {
      return isMasterAdmin();
    }

    function canManageGroup(groupId) {
      return isMasterAdmin() || isGroupAdmin(groupId);
    }

    function canViewGroupData(groupId) {
      return isMasterAdmin() 
        || isGroupAdmin(groupId)
        || userGroupId() == groupId;
    }

    // ========== COLLECTION: ROLES (Définitions des rôles) ==========
    match /roles/{roleId} {
      // Lecture: tous les utilisateurs authentifiés peuvent voir les définitions de rôles
      allow read: if isSignedIn();
      
      // Écriture: uniquement les super admins
      allow create, update, delete: if isSuperAdmin();
    }

    // ========== COLLECTION: USER CATEGORIES (Catégories d'utilisateurs) ==========
    match /userCategories/{categoryId} {
      // Lecture: tous les utilisateurs authentifiés peuvent voir les définitions de catégories
      allow read: if isSignedIn();
      
      // Écriture: uniquement les admins et super admins
      allow create, update, delete: if isMasterAdmin();
    }

    // ========== SOUS-COLLECTION: USER CATEGORY ASSIGNMENTS ==========
    match /users/{uid}/categories/{assignmentId} {
      // Lecture: utilisateur lui-même ou admins
      allow read: if isSignedIn() && (request.auth.uid == uid || isMasterAdmin());
      
      // Création: utilisateur pour les catégories auto-assignables, ou admins
      allow create: if isSignedIn() && (
        // L'utilisateur lui-même si la catégorie permet l'auto-assignation
        (request.auth.uid == uid && request.resource.data.requiresApproval == false)
        // Ou un admin
        || isMasterAdmin()
      );
      
      // Mise à jour/suppression: uniquement admins
      allow update, delete: if isMasterAdmin();
    }

    // ========== COLLECTION: USERS (Profils utilisateurs) ==========
    match /users/{uid} {
      // Lecture: utilisateur lui-même ou admins
      allow read: if isSignedIn() && (
        request.auth.uid == uid 
        || canManageUsers()
      );

      // Création: l'utilisateur crée son profil avec rôle 'user' par défaut,
      // ou admin peut créer pour d'autres
      allow create: if canManageUsers() || (
        isSignedIn()
        && request.auth.uid == uid
        && (request.resource.data.role == 'user' || !('role' in request.resource.data))
        && (!('isAdmin' in request.resource.data) || request.resource.data.isAdmin == false)
        && (!('groupId' in request.resource.data) || request.resource.data.groupId == null)
      );

      // Update: propriétaire peut modifier ses champs non privilégiés,
      // admin groupe peut modifier les membres de son groupe (sauf le rôle),
      // admin master peut tout modifier
      allow update: if canManageUsers() || (
        isSignedIn()
        && request.auth.uid == uid
        && request.resource.data.role == resource.data.role
        && request.resource.data.isAdmin == resource.data.isAdmin
        && request.resource.data.groupId == resource.data.groupId
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'email',
          'displayName',
          'photoUrl',
          'phone',
          'region',
          'fcmTokens',
          'updatedAt'
        ])
      ) || (
        // Admin groupe peut modifier les infos basiques des membres de son groupe
        isGroupAdmin(resource.data.groupId)
        && request.resource.data.role == resource.data.role
        && request.resource.data.isAdmin == resource.data.isAdmin
        && request.resource.data.groupId == resource.data.groupId
      );

      // Suppression: propriétaire ou admin master
      allow delete: if isSignedIn() && (
        request.auth.uid == uid 
        || canManageUsers()
      );

      // Sous-collections privées (cart, favorites, followingGroups, ...)
      match /{document=**} {
        allow read, write: if isSignedIn() && (
          request.auth.uid == uid 
          || canManageUsers()
        );
      }
    }

    // ========== COLLECTION: PLACES (Lieux) ==========
    match /places/{id} {
      // Lecture: publique
      allow read: if true;
      
      // Écriture: admins uniquement
      allow create, update, delete: if canManageContent();
    }

    // ========== COLLECTION: GROUPS (Groupes) ==========
    match /groups/{groupId} {
      // Lecture: publique
      allow read: if true;
      
      // Création: admin master uniquement
      allow create: if canManageContent();
      
      // Mise à jour: admin master ou admin du groupe spécifique
      allow update: if canManageGroup(groupId);
      
      // Suppression: admin master uniquement
      allow delete: if canManageContent();

      // Produits d’un groupe (shop)
      match /products/{productId} {
        // Lecture: public uniquement si validé (isActive=true), sinon réservé
        allow read: if resource.data.isActive == true || isMasterAdmin() || isGroupAdmin(groupId);

        // Création:
        // - master: libre
        // - admin groupe: UNIQUEMENT en attente (pending) et inactif
        allow create: if isMasterAdmin() || (
          isGroupAdmin(groupId)
          && request.resource.data.isActive == false
          && request.resource.data.moderationStatus == 'pending'
        );

        // Update:
        // - master: libre
        // - admin groupe: peut corriger tant que c'est pending/inactif
        //   et peut aussi resoumettre après refus (rejected -> pending)
        //   (interdit de passer actif/approved)
        allow update: if isMasterAdmin() || (
          isGroupAdmin(groupId)
          && resource.data.isActive == false
          && (resource.data.moderationStatus == 'pending' || resource.data.moderationStatus == 'rejected')
          && request.resource.data.isActive == false
          && request.resource.data.moderationStatus == 'pending'
        );

        allow delete: if isMasterAdmin() || isGroupAdmin(groupId);
      }

      // Historique points (écrit via Cloud Functions / Admin SDK)
      match /points/{pointId} {
        // Lecture: admin master ou admin groupe (sur SON groupe)
        allow read: if isMasterAdmin() || isGroupAdmin(groupId);
        allow create, update, delete: if false;
      }
    }

    // ========== COLLECTION: GROUP_LOCATIONS (Tracking en direct) ==========
    match /group_locations/{docId} {
      // Lecture: publique
      allow read: if true;
      
      // Écriture: via Cloud Functions uniquement
      allow create, update, delete: if false;
    }

    // ========== COLLECTION: POIs (Points d'intérêt) ==========
    match /pois/{id} {
      // Lecture: publique
      allow read: if true;
      
      // Écriture: admins uniquement
      allow create, update, delete: if canManageContent();
    }

    // ========== COLLECTION: CIRCUITS ==========
    match /circuits/{id} {
      // Lecture: publique
      allow read: if true;
      
      // Écriture: admins uniquement
      allow create, update, delete: if canManageContent();
    }

    // ========== COLLECTION: CONFIG ==========
    match /config/{id} {
      // Lecture: publique
      allow read: if true;
      
      // Écriture: admins uniquement
      allow create, update, delete: if canManageContent();
    }

    // ========== COLLECTION: ORDERS (Commandes) ==========
    match /orders/{orderId} {
      // Lecture:
      // - Utilisateur: ses propres commandes
      // - Admin groupe: commandes de son groupe
      // - Admin master: toutes les commandes
      allow read: if isSignedIn() && (
        resource.data.userId == request.auth.uid
        || canManageContent()
        || canViewGroupData(resource.data.groupId)
      );
      
      // Création: utilisateur authentifié avec son propre userId
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'groupId', 'items', 'totalPrice']);
      
      // Mise à jour/Suppression: admin master uniquement
      allow update, delete: if canManageContent();
    }

    // ========== REFUS PAR DÉFAUT ==========
    match /{document=**} {
      allow read, write: if false;
    }

  }
}

